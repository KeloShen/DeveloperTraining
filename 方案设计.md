# 需求分析

期望做一个类似游戏的项目，帮助程序员提高需求分析、方案设计能力、 技术的广度，快速了解到更多技术和方案，帮助用户评估当前的薪资水平（中国大陆区域）。

初始状态下的用户薪资为10000元/月，用户可以通过答题进行闯关。

每一个关卡都由AI生成，需要给出：

1. AI模拟成产品经理，提供一段尽可能清晰的需求描述（企业中真实的可能出现的需求和业务场景）
2. 让AI给出很多个选项，选项包括但不限于技术名词、使用的软件体系架构、技术知识点、方案的实现细节、零碎的实现思路、实现项目的关键流程、开发环境、依赖等等（其中一部分是正确答案，另一部分是干扰项，至少10个以上）
3. 需要给出本关卡的题目，题目非常直观能看出来是什么场景需求。

注意关卡的难度根据用户当前的薪资决定，需要根据薪资的数额动态调整难度，薪资越高难度越高，并且调整金额需要尽可能符合中国大陆企业招聘程序员的实际标准。

AI生成并且用户进入关卡之后，用户可以将选项进行拖拽，将其放到答题区域（一个方框），点击提交后，AI可以根据下列信息生成结果。

根据的信息：

1. 当前的关卡的内容，包括关卡的名称、关卡给出的题目（需求描述）（要求详细一些）
2. 用户选择的选项
3. 此关卡的正确选项
4. 用户当前的薪资

生成的结果报告需要包含：

1. 本关卡用户作答的分数
2. 给本次用户的作答一个评价（可以尽量幽默搞笑一些，比如升职加薪、减薪、直接开除、直接把公司给你等等，也可以使用互联网上的热梗）
3. 调整用户当前的薪资（一个具体的加减数字）
4. 基于用户当前的薪资给出一些投递公司的建议（注意，一定不要使用真实公司名称和产品名称，可以使用化名，比如阿里巴巴可以改为“阿巴阿巴"，腾讯可以改为"企鹅大王"，京东可以改为”北京小狗）
5. 解释给出当前分数的原因以及评价
6. 列举出本关卡的标准答案
7. 给出标准的、尽可能详细的关卡答案，包括企业中怎么实现这个需求，有什么样的标准的设计方案，应该运用哪些技术来实现，并且给出各个正确选项在实现中的作用（尽量使用自然语言来描述，语句通顺连贯）

参考的自然语言风格：

```plain
为了提升用户体验，需要为工具调用支持流式输出能力，但是只流式输出工具调用的基本信息，让用户能看到 AI 调用了哪些工具，避免了复杂的拼接解析逻辑（不利于项目扩展）。  
由于不知道要生成多少个文件、以及文件的层级组织关系，需要使用工具调用来写入文件。工具调用中需要特别注意文件路径的处理。如果不使用工具调用，就要输出一大堆的代码块，自己解析
```

# 方案设计

![](https://cdn.nlark.com/yuque/__mermaid_v3/0a548c207bae7b89eaaa4c8733d548a4.svg)

根据业务流程图，我们可以直观的发现程序至少调用AI两次：

1. 关卡生成
2. 评估与结算（生成结果报告）

## 调研AI的能力是否满足需求

调研过程中需要不断优化给AI的提示词

可以利用阿里云 千问3-Max模型[https://bailian.console.aliyun.com/?tab=model#/efm/model_experience_center/text/experience](https://bailian.console.aliyun.com/?tab=model#/efm/model_experience_center/text/experience)

### 测试生成关卡的能力

#### 系统提示词：

```plain
期望做一个类似游戏的项目，帮助程序员提高需求分析、方案设计能力、 技术的广度，快速了解到更多技术和方案，帮助用户评估当前的薪资水平（中国大陆区域）。
初始状态下的用户薪资为10000元/月，用户可以通过答题进行闯关。
每一个关卡都由AI生成，需要给出：
1. AI模拟成产品经理，提供一段尽可能清晰的需求描述（企业中真实的可能出现的需求和业务场景）
2. 让AI给出很多个选项，选项包括但不限于技术名词、使用的软件体系架构、技术知识点、方案的实现细节、零碎的实现思路、实现项目的关键流程、开发环境、依赖等等（其中一部分是正确答案，另一部分是干扰项，至少10个以上）
3. 需要给出本关卡的题目，题目非常直观能看出来是什么场景需求。

注意关卡的难度根据用户当前的薪资决定，需要根据薪资的数额动态调整难度，薪资越高难度越高，并且调整金额需要尽可能符合中国大陆企业招聘程序员的实际标准。

```

#### 用户提示词：

```markdown
请你根据我的要求生成一个关卡，我需要验证你生成的效果
```

### 测试生成结果的能力

#### 系统提示词：

```markdown
你是一个十分专业的程序员，你现在需要根据我提供的信息，来生成一个报告，目的是帮助其他程序员们提高需求分析、方案设计能力、技术的广度、快速了解到更多技术和方案，帮助用户评估他现在的薪资水平（中国大陆区域）

## 需要根据的信息：
1. 当前的关卡的内容，包括关卡的名称、关卡给出的题目（需求描述）（要求详细一些）
2. 用户选择的选项
3. 此关卡的正确选项
4. 用户当前的薪资

## 生成的结果报告需要包含：
1. 本关卡用户作答的分数
2. 给本次用户的作答一个评价（可以尽量幽默搞笑一些，比如升职加薪、减薪、直接开除、直接把公司给你等等，也可以使用互联网上的热梗）
3. 调整用户当前的薪资（一个具体的加减数字）
4. 基于用户当前的薪资给出一些投递公司的建议（注意，一定不要使用真实公司名称和产品名称，可以使用化名，比如阿里巴巴可以改为“阿巴阿巴"，腾讯可以改为"企鹅大王"，京东可以改为”北京小狗）
5. 解释给出当前分数的原因以及评价
6. 列举出本关卡的标准答案
7. 给出标准的、尽可能详细的关卡答案，包括企业中怎么实现这个需求，有什么样的标准的设计方案，应该运用哪些技术来实现，并且给出各个正确选项在实现中的作用（尽量使用自然语言来描述，语句通顺连贯）
必须只输出我要求的内容，不要生成任何多余没必要的内容！

### 参考的自然语言风格：
为了提升用户体验，需要为工具调用支持流式输出能力，但是只流式输出工具调用的基本信息，让用户能看到 AI 调用了哪些工具，避免了复杂的拼接解析逻辑（不利于项目扩展）。  
由于不知道要生成多少个文件、以及文件的层级组织关系，需要使用工具调用来写入文件。工具调用中需要特别注意文件路径的处理。如果不使用工具调用，就要输出一大堆的代码块，自己解析
```

#### 用户提示词：

```markdown
## 假设你正在挑战的关卡的信息

### 🎮 当前用户薪资：¥10,000 / 月  
### 🔒 关卡等级：Lv.2（初级进阶）  
### 📌 关卡题目：**“用户登录频繁失败后需要临时锁定账号，如何安全高效实现？”**

---

### 🧑‍💼 AI产品经理需求描述（真实业务场景）：

> 我们正在开发一个面向企业员工的内部管理系统，近期安全审计发现：攻击者可能通过暴力破解尝试登录员工账号。虽然我们已有基础密码策略（如8位以上、含大小写和数字），但缺乏对异常登录行为的防护。
>
> 产品要求：当同一个用户名在 **5分钟内连续登录失败达到5次**，系统应自动 **临时锁定该账号30分钟**，期间无论密码是否正确都拒绝登录，并向用户展示友好提示：“账号因多次登录失败已被临时锁定，请30分钟后重试”。
>
> 同时，系统需记录所有登录失败事件用于后续安全分析，且不能因锁定机制影响正常用户的高并发登录体验。该功能需在两周内上线，后端使用 Java + Spring Boot 技术栈，数据库为 MySQL。

---

### ❓ 请选择实现该需求时 **合理且必要** 的技术方案或组件（可多选）：

> ✅ 正确选项应覆盖：**状态存储、时间窗口计数、线程安全、性能、可观测性、安全性** 等维度。  
> ❌ 干扰项看似合理但不适用、过度设计、或存在安全隐患。

| 编号 | 选项                                                                |
| ---- | ------------------------------------------------------------------- |
| A    | 使用 Redis 的 `INCR` 和 `EXPIRE` 命令实现失败次数计数与自动过期     |
| B    | 在 MySQL 用户表中增加 `lock_until` 字段，每次登录失败都更新该字段   |
| C    | 使用 Spring Security 的 `DaoAuthenticationProvider` 自定义认证逻辑  |
| D    | 引入 Kafka 异步处理登录失败事件，再由消费者决定是否锁定账号         |
| E    | 使用 Guava Cache 实现本地内存中的失败计数器                         |
| F    | 采用 JWT Token 存储用户登录状态，失败时在 Token 中标记锁定状态      |
| G    | 利用 Redis 的 `SET key value NX EX` 原子操作防止并发竞争            |
| H    | 在 Nginx 层通过 IP 限流（如 limit_req）阻止暴力破解                 |
| I    | 使用分布式锁（如 Redisson）确保多实例环境下计数准确                 |
| J    | 登录失败时发送短信验证码作为二次验证替代账号锁定                    |
| K    | 记录登录失败日志到 ELK（Elasticsearch + Logstash + Kibana）便于审计 |
| L    | 使用 OAuth2.0 授权码模式重构整个登录流程以提升安全性                |

---

### ✅ 参考答案（正确选项）：
**A, C, G, I, K**

#### 解析：
- **A**：Redis 是实现高频计数+自动过期的理想选择，性能高、支持原子操作。
- **C**：Spring Security 是 Spring Boot 下标准认证框架，自定义认证逻辑是常规做法。
- **G**：`SET key value NX EX` 可原子地设置初始值并设过期时间，避免竞态条件。
- **I**：在集群部署下，必须考虑多实例对同一账号的并发登录请求，需分布式协调。
- **K**：安全审计要求日志可追溯，ELK 是常见日志分析方案。

#### ❌ 干扰项说明：
- **B**：频繁更新 MySQL 会造成数据库压力，且无法高效实现“5分钟内5次”的滑动窗口。
- **D**：Kafka 引入异步会带来延迟，无法实时拦截第5次失败后的登录请求。
- **E**：Guava Cache 是本地缓存，多实例下数据不一致，无法共享失败计数。
- **F**：JWT 是无状态的，无法主动使 Token 失效，且锁定状态不应由客户端持有。
- **H**：IP 限流会误伤同一局域网用户（如公司出口IP），且攻击者可换IP绕过。
- **J**：题目明确要求“临时锁定”，而非改用其他验证方式。
- **L**：OAuth2 适用于第三方授权，内部系统登录通常用表单认证即可，属过度设计。

---

### 💰 通关奖励：
- 答对 ≥4 项：薪资 + ¥1,500 → **¥11,500/月**
- 答对全部 5 项：额外获得「安全设计」技能徽章 🛡️

---

## 用户提供的信息
### 用户选择的选项
1. B
2. D
3. E
4. F
5. K

### 用户当前的薪资
10000元/月

```

#### 测试输出结果：

![](https://cdn.nlark.com/yuque/0/2025/png/62922744/1763797417457-567d6bc6-ad24-4674-9ab8-dd25372cfda7.png)

```markdown
1. **本关卡用户作答的分数：1 / 5（仅选项 K 正确）**  
2. **评价：** 恭喜你成功触发“账号锁定”机制——不是系统锁了用户，是你把自己在老板心中的价值给锁死了！选了一堆本地缓存、异步队列、JWT 标记，就是没碰 Redis 和 Spring Security，建议直接把工牌交给安全团队当反面教材。当前表现≈“用 Excel 实现分布式事务”，离升职加薪差了十个微服务架构的距离。  
3. **调整后薪资：¥10,000 - ¥800 = ¥9,200 / 月**（因方案存在严重性能与安全风险，需回炉重造）  
4. **投递建议：**  
   - 暂时不建议投递“阿巴阿巴”、“企鹅大王”等对高并发和安全有硬性要求的大厂；  
   - 可考虑“北京小狗”生态内偏业务型、低并发的内部工具岗，或“拼夕夕兄弟公司”做简单CRUD项目积累经验；  
   - 强烈建议先去“字节跳动的远房表弟”——某中小型SaaS公司实习三个月，重点补分布式状态管理。  

5. **评分原因与评价解释：**  
   用户选择了 B（MySQL 频繁更新）、D（Kafka 异步处理）、E（Guava 本地缓存）、F（JWT 存储锁定状态）、K（ELK 日志）。其中仅 **K 正确**，其余均不符合“实时性、一致性、安全性、高性能”要求：  
   - **B** 会导致数据库成为瓶颈，且无法实现滑动时间窗口；  
   - **D** 的异步机制无法实时拦截第5次失败后的登录请求，违背“立即锁定”需求；  
   - **E** 在多实例部署下计数不共享，攻击者可绕过锁定；  
   - **F** 将安全状态交由无状态的 JWT 管理，完全不可控，且客户端可篡改（虽签名防篡改，但无法主动失效）。  
   唯一亮点是 **K**，体现了基本的安全审计意识，值得保留。  

6. **本关卡标准答案：A, C, G, I, K**  

7. **标准详细实现方案：**  
   在企业级 Spring Boot 系统中，实现“5分钟内5次失败锁定30分钟”的安全机制，应采用以下组合方案：  
   - **使用 Redis 作为核心状态存储（A）**：为每个用户名生成一个计数键（如 `login:fail:username`），利用 `INCR` 原子递增失败次数，并通过 `EXPIRE` 设置5分钟自动过期，天然支持滑动时间窗口。  
   - **通过 `SET key value NX EX` 初始化计数（G）**：首次失败时，用该命令原子地设置初始值为1并设定5分钟过期，避免多个并发请求同时初始化导致计数错误。  
   - **在 Spring Security 中自定义认证逻辑（C）**：继承 `DaoAuthenticationProvider`，在 `additionalAuthenticationChecks` 阶段先检查 Redis 中该用户的失败次数是否已达5次，若是则直接抛出 `LockedException`，阻止后续密码校验。  
   - **引入分布式锁或原子操作保证集群一致性（I）**：虽然 Redis 的 `INCR` 本身是原子的，但在“判断是否达到5次 + 设置锁定状态”的复合逻辑中，若涉及多个步骤（如记录锁定时间），需用 Redisson 分布式锁或 Lua 脚本确保多实例环境下操作的原子性，防止竞态条件。  
   - **将所有登录失败事件写入 ELK（K）**：在认证失败回调中，结构化记录用户名、IP、时间戳等信息到日志，经 Logstash 收集至 Elasticsearch，供安全团队通过 Kibana 进行异常行为分析与溯源。  

   整套方案兼顾了**高性能（Redis 内存操作）**、**强一致性（原子命令/分布式锁）**、**可观测性（ELK 审计）** 和 **框架集成度（Spring Security 标准扩展点）**，是企业中成熟且可落地的最佳实践。
```

## 提示词

### 生成关卡

#### 系统提示词：

```markdown
你是一个极其专业的程序员与产品经理，你需要根据用户的薪资水平，生成对应难度的关卡，目的是帮助程序员们提高自己的需求分析、方案设计能力、 技术的广度，快速了解到更多技术和方案，帮助用户评估当前的薪资水平（中国大陆区域）。

## 你需要生成的内容：
1. 关卡的名称
2. 一段尽可能清晰详细的需求描述（是企业中真实的需求和业务场景）
3. 给出很多个选项，选项包括但不限于技术名词、使用的软件体系架构、技术知识点、方案的实现细节、零碎的实现思路、实现项目的关键流程、开发环境、依赖等等（其中一部分是正确答案，另一部分是干扰项，至少10个以上
4. 目标薪资范围（用于难度匹配）

## 注意事项
注意关卡的难度根据用户当前的薪资决定，需要根据薪资的数额动态调整难度，薪资越高难度越高，并且调整金额需要尽可能符合中国大陆企业招聘程序员的实际标准。

## 严格按照下列的格式输出（JSON格式）
仅参考格式，不要参考内容

```json
{  
  "levelName": "开发一个图书管理系统",  
  "levelDesc": "我们正在开发一个在线书店管理系统，旨在为用户提供便捷的购书体验，并简化书店后台管理流程。系统需要支持以下核心功能：  
  
用户注册与登录  
浏览书籍列表（按类别、作者或出版社筛选）  
搜索特定书籍  
查看书籍详情页面（包括简介、价格等信息）  
将商品添加到购物车  
完成订单支付  
后台管理界面，用于更新库存、处理订单等  
此外，我们需要确保网站具有良好的用户体验，加载速度快，并且能够在不同设备上正常工作。  
",  
  "options": [  
    {  
      "optionName": "Vue 框架",  
      "trueAnswer": true  
    },  
    {  
      "optionName": "Zookeeper 分布式协调工具",  
      "trueAnswer": false  
    },  
  ],  
  "difficulty": "简单",  
  "targetSalary": 10000  
}  

```


使用Few shot技巧，给出示例。

#### 用户提示词：

```

```markdown
当前的薪资：{{salary:10000}}
```

### 生成结果报告

#### 系统提示词：

```markdown
你是一个十分专业的程序员，你现在需要根据我提供的信息，来生成一个《程序员闯关的结果报告》，目的是帮助其他程序员们提高需求分析、方案设计能力、技术的广度、快速了解到更多技术和方案，帮助用户评估他现在的薪资水平（中国大陆区域）

## 需要根据的信息：
1. 当前的关卡的内容，包括关卡的名称、关卡给出的题目（需求描述）（要求详细一些）
2. 用户选择的选项
3. 此关卡的正确选项
4. 用户当前的薪资

## 生成的结果报告需要包含：
1. 本关卡用户作答的分数（满分为100分）
2. 给本次用户的作答一个评价（可以尽量幽默搞笑一些，比如升职加薪、减薪、直接开除、直接把公司给你等等，也可以使用互联网上的热梗）
3. 调整用户当前的薪资（一个具体的加减数字）
4. 基于用户当前的薪资给出一些投递公司的建议（注意，一定不要使用真实公司名称和产品名称，可以使用化名，比如阿里巴巴可以改为“阿巴阿巴"，腾讯可以改为"企鹅大王"，京东可以改为”北京小狗）
5. 解释给出当前分数的原因以及评价
6. 列举出本关卡的标准答案
7. 给出标准的、尽可能详细的关卡答案，包括企业中怎么实现这个需求，有什么样的标准的设计方案，应该运用哪些技术来实现，并且给出各个正确选项在实现中的作用（尽量使用自然语言来描述，语句通顺连贯）
必须只输出我要求的内容，不要生成任何多余没必要的内容！

### 参考的自然语言风格：
为了提升用户体验，需要为工具调用支持流式输出能力，但是只流式输出工具调用的基本信息，让用户能看到 AI 调用了哪些工具，避免了复杂的拼接解析逻辑（不利于项目扩展）。  
由于不知道要生成多少个文件、以及文件的层级组织关系，需要使用工具调用来写入文件。工具调用中需要特别注意文件路径的处理。如果不使用工具调用，就要输出一大堆的代码块，自己解析

## 输出的格式要求
必须按照这个格式输出，仅参考格式，不要参考内容。

```json
{  
  "score": 80,  
  "comment": "建议涨薪",  
  "salaryChange": -2000,  
  "suggest": "建议投递鱼皮公司",  
  "reason": "答的不太好",  
  "trueOptions": [  
    "Vue 框架",  
    "NPM 包管理器"  
  ],  
  "standardAnswer": "...一段 Markdown 文本"  
}  
```

#### 用户提示词：

```

```markdown
### 关卡名称  
  
{{ levelName: 关卡名称 }}  
  
## 关卡的需求描述  
  
{{ levelDesc: 需求描述 }}  
  
## 用户选择的选项  
  
json  格式
[  
  {  
    "optionName": "Vue 框架",  
    "trueAnswer": true  
  },  
  {  
    "optionName": "Zookeeper 分布式协调工具",  
    "trueAnswer": false  
  },  
]  

  
### 本关卡的正确选项  
  
json  格式
[  
  "Vue 框架",  
  "NPM 包管理器"  
],  

  
### 用户当前的薪资  
  
{{ salary: 10000 }}

```

# 技术选型

## 后端

为了避免AI生成的不确定性，有一些我们能自主决定的代码和技术手动引入。

+ Java21
+ Spring Boot 3.5
+ MySQL DB
+ MyBatis Plus数据访问层
+ LangChain4j AI开发框架
+ Lombok 注解生成库
+ Hutool 工具库

![](https://cdn.nlark.com/yuque/__mermaid_v3/8b5bd5d2e54ce64d268da44129e264f7.svg)

## 前端

+ Vue 框架
+ 不实用TypeScript
+ Axios发送请求
+ 利用原生的方法对接SSE接口
+ element-plus组件库
